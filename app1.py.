import streamlit as st
from docx import Document
from docx.shared import Pt, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.oxml.ns import qn
from docx.enum.table import WD_TABLE_DIRECTION
from cerebras.cloud.sdk import Cerebras
import pandas as pd
import json
import io

# ---------------------------------------------------------
# 1. ุฅุนุฏุงุฏ ุงูุชูููุช ุงูุฃุณุจูุนู (ุจูุงุกู ุนูู ุงูุตูุฑุฉ 1)
# ---------------------------------------------------------
# ููุงุญุธุฉ: ุชู ุชูุฏูุฑ ุงูุชูููุช ุจูุงุกู ุนูู ุงููุชุฑุงุช ุงูุฒูููุฉ ุงูููุงุณูุฉ (30 ุฏูููุฉ ููุญุตุฉ)
WEEKLY_SCHEDULE = {
    "ุงูุฃุญุฏ": [
        {"time": "08:00 - 09:45", "activity": "ุชุนุจูุฑ ุดููู"},
        {"time": "08:00 - 09:45", "activity": "ูุจุงุฏุฆ ุงููุฑุงุกุฉ"},
        {"time": "08:00 - 09:45", "activity": "ุฑูุงุถูุงุช"},
        {"time": "10:00 - 11:15", "activity": "ุช ุนูููุฉ"},
        {"time": "10:00 - 11:15", "activity": "ุช ุฅุณูุงููุฉ"},
        {"time": "13:00 - 15:00", "activity": "ูุณุฑุญ ูุนุฑุงุฆุณ"},
        {"time": "13:00 - 15:00", "activity": "ุฑุณู ูุฃุดุบุงู"},
        {"time": "13:00 - 15:00", "activity": "ุช ุจุฏููุฉ"}
    ],
    "ุงูุงุซููู": [
        {"time": "08:00 - 09:45", "activity": "ุฑูุงุถูุงุช"},
        {"time": "08:00 - 09:45", "activity": "ุชุนุจูุฑ ุดููู"},
        {"time": "08:00 - 09:45", "activity": "ุชุฎุทูุท"},
        {"time": "10:00 - 11:15", "activity": "ุช ุนูููุฉ"},
        {"time": "10:00 - 11:15", "activity": "ุช ูุฏููุฉ"},
        {"time": "13:00 - 15:00", "activity": "ูุณุฑุญ ูุนุฑุงุฆุณ"},
        {"time": "13:00 - 15:00", "activity": "ุฑุณู ูุฃุดุบุงู"},
        {"time": "13:00 - 15:00", "activity": "ุช ุจุฏููุฉ"}
    ],
    "ุงูุซูุงุซุงุก": [
        {"time": "08:00 - 09:45", "activity": "ุชุนุจูุฑ ุดููู"},
        {"time": "08:00 - 09:45", "activity": "ูุจุงุฏุฆ ุงููุฑุงุกุฉ"},
        {"time": "08:00 - 09:45", "activity": "ุฑูุงุถูุงุช"},
        {"time": "10:00 - 11:15", "activity": "ุช ุฅุณูุงููุฉ"},
        {"time": "10:00 - 11:15", "activity": "ุช ุจุฏููุฉ"}
    ],
    "ุงูุฃุฑุจุนุงุก": [
        {"time": "08:00 - 09:45", "activity": "ุฑูุงุถูุงุช"},
        {"time": "08:00 - 09:45", "activity": "ูุจุงุฏุฆ ุงููุฑุงุกุฉ"},
        {"time": "08:00 - 09:45", "activity": "ุชุฎุทูุท"},
        {"time": "10:00 - 11:15", "activity": "ุช ุนูููุฉ"},
        {"time": "10:00 - 11:15", "activity": "ุช ูุฏููุฉ"},
        {"time": "13:00 - 15:00", "activity": "ุช ุฅููุงุนูุฉ"},
        {"time": "13:00 - 15:00", "activity": "ููุณููู ูุฅูุดุงุฏ"},
        {"time": "13:00 - 15:00", "activity": "ุช ุจุฏููุฉ"}
    ],
    "ุงูุฎููุณ": [
        {"time": "08:00 - 09:45", "activity": "ูุจุงุฏุฆ ุงููุฑุงุกุฉ"},
        {"time": "08:00 - 09:45", "activity": "ุฑูุงุถูุงุช"},
        {"time": "08:00 - 09:45", "activity": "ุช ุนูููุฉ"},
        {"time": "10:00 - 11:15", "activity": "ุช ุฅููุงุนูุฉ"},
        {"time": "10:00 - 11:15", "activity": "ููุณููู ูุฅูุดุงุฏ"}
    ]
}

# ---------------------------------------------------------
# 2. ุฅุนุฏุงุฏ ุงูุตูุญุฉ
# ---------------------------------------------------------
st.set_page_config(page_title="ุงููุฐูุฑุฉ ุงูููููุฉ ุงูุขููุฉ", layout="wide", page_icon="๐")
st.markdown("""<style>.main { direction: rtl; text-align: right; } h1, h2, h3, p, div { text-align: right; }</style>""", unsafe_allow_html=True)

# ---------------------------------------------------------
# 3. ุฏูุงู ุงููุนุงูุฌุฉ (ููุณ ุงูุฏูุงู ุงูุณุงุจูุฉ ูุน ุชุนุฏููุงุช ุจุณูุทุฉ)
# ---------------------------------------------------------
def extract_text_from_docx(file):
    doc = Document(file)
    full_text = []
    for para in doc.paragraphs:
        if para.text.strip(): full_text.append(para.text)
    for table in doc.tables:
        for row in table.rows:
            row_text = [cell.text.strip().replace("\n", " ") for cell in row.cells if cell.text.strip()]
            if row_text: full_text.append(" | ".join(row_text))
    return "\n".join(full_text)

def analyze_with_cerebras(text, key, model_id):
    client = Cerebras(api_key=key)
    # ุชุญุณูู ุงูุจุฑููุจุช ููุชูุงูู ูุน ุฃุณูุงุก ุงูุฃูุดุทุฉ ูู ุงูุฌุฏูู
    system_prompt = """
    ุฃูุช ูุณุงุนุฏ ุชุฑุจูู. ุงุณุชุฎุฑุฌ ุจูุงูุงุช ุงูุฏุฑูุณ ูู ุงููุต.
    ุงูุญููู ุงููุทููุจุฉ:
    1. "ุงููุดุงุท": (ูุฌุจ ุฃู ูููู ูุทุงุจูุงู ุชูุงูุงู ูุฃุญุฏ ูุฐู ุงููุตุทูุญุงุช: ุฑูุงุถูุงุชุ ุชุนุจูุฑ ุดูููุ ูุจุงุฏุฆ ุงููุฑุงุกุฉุ ุชุฎุทูุทุ ุช ุนูููุฉุ ุช ุฅุณูุงููุฉุ ุช ูุฏููุฉุ ุช ุจุฏููุฉุ ูุณุฑุญ ูุนุฑุงุฆุณุ ุฑุณู ูุฃุดุบุงูุ ุช ุฅููุงุนูุฉุ ููุณููู ูุฅูุดุงุฏ).
    2. "ุงูููุถูุน": ุนููุงู ุงูุฏุฑุณ.
    3. "ุงูููุงุกุฉ": ุงูููุงุกุฉ ุงููุงุนุฏูุฉ ุฃู ุงููุณุชูุฏูุฉ.
    4. "ุงููุคุดุฑ": ูุคุดุฑ ุงูููุงุกุฉ.
    
    ุงููุฎุฑุฌ JSON List ููุท.
    """
    try:
        completion = client.chat.completions.create(
            model=model_id,
            messages=[{"role": "system", "content": system_prompt}, {"role": "user", "content": text[:20000]}],
            temperature=0.1,
            response_format={"type": "json_object"}
        )
        return json.loads(completion.choices[0].message.content)
    except Exception as e:
        return {"error": str(e)}

# ---------------------------------------------------------
# 4. ุฏุงูุฉ ุฅูุดุงุก ููู ุงููุฐูุฑุฉ ุงูููููุฉ (Word)
# ---------------------------------------------------------
def create_daily_journal(day_name, extracted_lessons):
    doc = Document()
    
    # ุชูุณูู ุงูุตูุญุฉ ูููุชุงุจุฉ ูู ุงููููู ูููุณุงุฑ
    section = doc.sections[0]
    section.page_width = Inches(8.27) # A4
    section.page_height = Inches(11.69)
    
    # ุนููุงู
    title = doc.add_heading(f'ุงููุฐูุฑุฉ ุงูููููุฉ - ููู: {day_name}', 0)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER

    # ุฅูุดุงุก ุงูุฌุฏูู (ูุดุจู ุงูุตูุฑุฉ 2)
    # ุงูุฃุนูุฏุฉ: ุงูุชูููุชุ ุงููุดุงุทุ ุงูููุถูุนุ ุงูููุงุกุฉุ ุงููุคุดุฑุ ููุงุญุธุงุช
    headers = ["ุงูุชูููุช", "ุงููุดุงุท", "ุงูููุถูุน (ุงููุญุชูู)", "ุงูููุงุกุฉ", "ุงููุคุดุฑ", "ููุงุญุธุงุช"]
    table = doc.add_table(rows=1, cols=len(headers))
    table.style = 'Table Grid'
    table.direction = WD_TABLE_DIRECTION.RTL # ุงุชุฌุงู ุงูุฌุฏูู ูููู ูุณุงุฑ
    
    # ุชุนุจุฆุฉ ุงูุนูุงููู
    hdr_cells = table.rows[0].cells
    for i, header in enumerate(headers):
        hdr_cells[i].text = header
        # ุฌุนู ุงูุฎุท ุบููุธ ููุนูุงููู
        run = hdr_cells[i].paragraphs[0].runs[0]
        run.font.bold = True
        run.font.size = Pt(11)

    # ุฌูุจ ุฌุฏูู ุงูููู ุงููุญุฏุฏ
    day_schedule = WEEKLY_SCHEDULE.get(day_name, [])
    
    # ุงูุจุญุซ ุนู ุงูุจูุงูุงุช ููุทุงุจูุชูุง
    # extracted_lessons ูุฌุจ ุฃู ุชููู ูุงุฆูุฉ ูู ุงูููุงููุณ
    lessons_list = []
    if isinstance(extracted_lessons, dict):
        for val in extracted_lessons.values():
            if isinstance(val, list): lessons_list = val; break
        if not lessons_list: lessons_list = [extracted_lessons]
    else:
        lessons_list = extracted_lessons

    # ุชุนุจุฆุฉ ุงูุฌุฏูู
    for slot in day_schedule:
        row_cells = table.add_row().cells
        
        # ุชุนุจุฆุฉ ุงูุชูููุช ูุงููุดุงุท ูู ุงูุฌุฏูู ุงูุซุงุจุช
        row_cells[0].text = slot['time']
        row_cells[1].text = slot['activity']
        
        # ุงูุจุญุซ ุนู ูุญุชูู ุงูุฏุฑุณ ูู ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ (Matching)
        found_lesson = None
        for lesson in lessons_list:
            # ูุทุงุจูุฉ ูุฑูุฉ ูููุต
            if slot['activity'] in lesson.get('ุงููุดุงุท', '') or lesson.get('ุงููุดุงุท', '') in slot['activity']:
                found_lesson = lesson
                break
        
        if found_lesson:
            row_cells[2].text = str(found_lesson.get('ุงูููุถูุน', ''))
            row_cells[3].text = str(found_lesson.get('ุงูููุงุกุฉ', ''))
            row_cells[4].text = str(found_lesson.get('ุงููุคุดุฑ', ''))
        else:
            row_cells[2].text = "" # ุชุฑู ุงูููุงู ูุงุฑุบ ูููุชุงุจุฉ ุงููุฏููุฉ ุฅุฐุง ูู ูุฌุฏ ุงูุฏุฑุณ

        # ุชูุณูู ุงูุฎุท ุฏุงุฎู ุงูุฎูุงูุง
        for cell in row_cells:
            for paragraph in cell.paragraphs:
                paragraph.alignment = WD_ALIGN_PARAGRAPH.RIGHT
                if paragraph.runs:
                    paragraph.runs[0].font.size = Pt(10)
                    paragraph.runs[0].font.name = "Arial"

    return doc

# ---------------------------------------------------------
# 5. ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ
# ---------------------------------------------------------
with st.sidebar:
    st.header("โ๏ธ ุงูุฅุนุฏุงุฏุงุช")
    if "CEREBRAS_API_KEY" in st.secrets:
        api_key = st.secrets["CEREBRAS_API_KEY"]
    else:
        api_key = st.text_input("API Key", type="password")
    
    model_choice = st.selectbox("ุงููููุฐุฌ", ["llama3.1-70b", "llama-3.3-70b"])

st.title("๐ ูููุฏ ุงููุฐูุฑุฉ ุงูููููุฉ ุงูุขูู")
st.info("ุงุฑูุน ููู ุงููุฐูุฑุงุช (Word)ุ ูุณุฃููู ุจููุก ุฌุฏูู ุงูุชูููุช ุงูุฃุณุจูุนู (ุงูุตูุฑุฉ 1) ูู ูููุฐุฌ ุงููุฐูุฑุฉ ุงูููููุฉ (ุงูุตูุฑุฉ 2).")

uploaded_file = st.file_uploader("๐ ุงุฎุชุฑ ููู ุงููุฐูุฑุงุช (.docx)", type=["docx"])
selected_day = st.selectbox("๐ ุงุฎุชุฑ ุงูููู ูุฅูุดุงุก ุงููุฐูุฑุฉ:", list(WEEKLY_SCHEDULE.keys()))

if uploaded_file and st.button("๐ ุฅูุดุงุก ุงููุฐูุฑุฉ"):
    if not api_key:
        st.error("ููุชุงุญ API ููููุฏ.")
    else:
        with st.spinner('ุฌุงุฑู ุชุญููู ุงูุฏุฑูุณ ููุทุงุจูุชูุง ูุน ุงูุฌุฏูู...'):
            try:
                # 1. ุงุณุชุฎุฑุงุฌ ุงููุตูุต
                text = extract_text_from_docx(uploaded_file)
                # 2. ุชุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                data = analyze_with_cerebras(text, api_key, model_choice)
                
                if "error" not in data:
                    # 3. ุฅูุดุงุก ููู Word
                    doc = create_daily_journal(selected_day, data)
                    
                    # ุญูุธ ูู ุงูุฐุงูุฑุฉ
                    bio = io.BytesIO()
                    doc.save(bio)
                    
                    st.success(f"ุชู ุฅูุดุงุก ูุฐูุฑุฉ ููู {selected_day} ุจูุฌุงุญ!")
                    
                    st.download_button(
                        label=f"๐ฅ ุชุญููู ูุฐูุฑุฉ {selected_day} (Word)",
                        data=bio.getvalue(),
                        file_name=f"Daily_Journal_{selected_day}.docx",
                        mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                    )
                    
                    # ุนุฑุถ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ ูููุฑุงุฌุนุฉ
                    st.markdown("### ุงูุจูุงูุงุช ุงูุชู ุชู ุงุณุชุฎุฑุงุฌูุง:")
                    st.json(data)
                else:
                    st.error(f"ุฎุทุฃ: {data['error']}")
            except Exception as e:
                st.error(f"ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน: {e}")
